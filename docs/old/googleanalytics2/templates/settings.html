{% extends 'base.html' %}

{% block title %}Settings - GA4 Dashboard{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg p-6 mb-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Settings</h1>
            <p class="text-gray-600">Configure application settings and preferences</p>
        </div>
    </div>
    
    {% if is_authenticated %}
    <form action="{{ url_for('update_settings') }}" method="post">
        <div class="space-y-6">
    {% else %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    You need to <a href="{{ url_for('login') }}" class="font-medium underline text-yellow-700 hover:text-yellow-600">log in</a> to update settings.
                    However, you can still view and configure your API key below.
                </p>
            </div>
        </div>
    </div>
    <div class="space-y-6">
    {% endif %}
            <!-- API Configuration Section -->
            <div>
                <h2 class="text-lg font-medium text-gray-900 mb-4">API Configuration</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 gap-6">
                        <div class="form-group">
                            <label for="setting_google_api_key" class="form-label">Google API Key</label>
                            <div class="relative">
                                <input type="password" id="setting_google_api_key" name="setting_google_api_key" class="form-input pr-10" placeholder="{% if settings|selectattr('key', 'eq', 'google_api_key')|first %}*************{% else %}Enter your Google API key{% endif %}">
                                <button type="button" id="toggle-api-key" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5" title="Toggle API key visibility">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">Your Google API key for authentication (leave empty to keep existing key)</p>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mt-2">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        The API key is stored securely and encrypted in the database. It will be used as a fallback when OAuth authentication is not available.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- API Settings Section -->
            <div>
                <h2 class="text-lg font-medium text-gray-900 mb-4">API Settings</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="setting_api_request_timeout" class="form-label">API Request Timeout (seconds)</label>
                            <input type="number" id="setting_api_request_timeout" name="setting_api_request_timeout" class="form-input" value="{{ settings|selectattr('key', 'eq', 'api_request_timeout')|map(attribute='value')|first|default('60') }}">
                            <p class="text-sm text-gray-500 mt-1">Maximum time to wait for API responses</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="setting_max_concurrent_requests" class="form-label">Max Concurrent Requests</label>
                            <input type="number" id="setting_max_concurrent_requests" name="setting_max_concurrent_requests" class="form-input" value="{{ settings|selectattr('key', 'eq', 'max_concurrent_requests')|map(attribute='value')|first|default('5') }}">
                            <p class="text-sm text-gray-500 mt-1">Maximum number of concurrent API requests</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PDF Generation Settings Section -->
            <div>
                <h2 class="text-lg font-medium text-gray-900 mb-4">PDF Generation Settings</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="setting_wkhtmltopdf_path" class="form-label">wkhtmltopdf Path</label>
                            <input type="text" id="setting_wkhtmltopdf_path" name="setting_wkhtmltopdf_path" class="form-input" value="{{ settings|selectattr('key', 'eq', 'wkhtmltopdf_path')|map(attribute='value')|first|default('/usr/local/bin/wkhtmltopdf') }}">
                            <p class="text-sm text-gray-500 mt-1">Path to wkhtmltopdf executable</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="setting_default_pdf_format" class="form-label">Default PDF Format</label>
                            <select id="setting_default_pdf_format" name="setting_default_pdf_format" class="form-input">
                                <option value="A4" {% if settings|selectattr('key', 'eq', 'default_pdf_format')|map(attribute='value')|first|default('A4') == 'A4' %}selected{% endif %}>A4</option>
                                <option value="Letter" {% if settings|selectattr('key', 'eq', 'default_pdf_format')|map(attribute='value')|first|default('A4') == 'Letter' %}selected{% endif %}>Letter</option>
                                <option value="Legal" {% if settings|selectattr('key', 'eq', 'default_pdf_format')|map(attribute='value')|first|default('A4') == 'Legal' %}selected{% endif %}>Legal</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1">Default paper format for PDF reports</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Settings Section -->
            <div>
                <h2 class="text-lg font-medium text-gray-900 mb-4">Report Settings</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="setting_default_date_range" class="form-label">Default Date Range (days)</label>
                            <input type="number" id="setting_default_date_range" name="setting_default_date_range" class="form-input" value="{{ settings|selectattr('key', 'eq', 'default_date_range')|map(attribute='value')|first|default('30') }}">
                            <p class="text-sm text-gray-500 mt-1">Default number of days for report date ranges</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="setting_include_summary_by_default" class="form-label">Include Summary by Default</label>
                            <select id="setting_include_summary_by_default" name="setting_include_summary_by_default" class="form-input">
                                <option value="true" {% if settings|selectattr('key', 'eq', 'include_summary_by_default')|map(attribute='value')|first|default('true') == 'true' %}selected{% endif %}>Yes</option>
                                <option value="false" {% if settings|selectattr('key', 'eq', 'include_summary_by_default')|map(attribute='value')|first|default('true') == 'false' %}selected{% endif %}>No</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1">Whether to include executive summaries in PDF reports by default</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- UI Settings Section -->
            <div>
                <h2 class="text-lg font-medium text-gray-900 mb-4">UI Settings</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="setting_items_per_page" class="form-label">Items Per Page</label>
                            <input type="number" id="setting_items_per_page" name="setting_items_per_page" class="form-input" value="{{ settings|selectattr('key', 'eq', 'items_per_page')|map(attribute='value')|first|default('20') }}">
                            <p class="text-sm text-gray-500 mt-1">Number of items to display per page in tables</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="setting_chart_theme" class="form-label">Chart Theme</label>
                            <select id="setting_chart_theme" name="setting_chart_theme" class="form-input">
                                <option value="default" {% if settings|selectattr('key', 'eq', 'chart_theme')|map(attribute='value')|first|default('default') == 'default' %}selected{% endif %}>Default</option>
                                <option value="light" {% if settings|selectattr('key', 'eq', 'chart_theme')|map(attribute='value')|first|default('default') == 'light' %}selected{% endif %}>Light</option>
                                <option value="dark" {% if settings|selectattr('key', 'eq', 'chart_theme')|map(attribute='value')|first|default('default') == 'dark' %}selected{% endif %}>Dark</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1">Theme for charts and graphs</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Settings Section -->
            <div>
                <h2 class="text-lg font-medium text-gray-900 mb-4">Advanced Settings</h2>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="setting_cache_timeout" class="form-label">Cache Timeout (minutes)</label>
                            <input type="number" id="setting_cache_timeout" name="setting_cache_timeout" class="form-input" value="{{ settings|selectattr('key', 'eq', 'cache_timeout')|map(attribute='value')|first|default('60') }}">
                            <p class="text-sm text-gray-500 mt-1">Time to cache API responses</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="setting_log_level" class="form-label">Log Level</label>
                            <select id="setting_log_level" name="setting_log_level" class="form-input">
                                <option value="DEBUG" {% if settings|selectattr('key', 'eq', 'log_level')|map(attribute='value')|first|default('INFO') == 'DEBUG' %}selected{% endif %}>Debug</option>
                                <option value="INFO" {% if settings|selectattr('key', 'eq', 'log_level')|map(attribute='value')|first|default('INFO') == 'INFO' %}selected{% endif %}>Info</option>
                                <option value="WARNING" {% if settings|selectattr('key', 'eq', 'log_level')|map(attribute='value')|first|default('INFO') == 'WARNING' %}selected{% endif %}>Warning</option>
                                <option value="ERROR" {% if settings|selectattr('key', 'eq', 'log_level')|map(attribute='value')|first|default('INFO') == 'ERROR' %}selected{% endif %}>Error</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1">Application logging level</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% if is_authenticated %}
        <div class="mt-8">
            <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Save Settings
            </button>
        </div>
    </form>
        {% else %}
        <div class="mt-8">
            <a href="{{ url_for('login') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Login to Save Settings
            </a>
        </div>
    </div>
        {% endif %}
</div>

<div class="bg-white shadow rounded-lg p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">About Settings</h2>
    <div class="prose max-w-none">
        <p>Configure various aspects of the GA4 Dashboard application to customize its behavior and appearance.</p>
        
        <h3 class="text-md font-medium mt-4">Setting Categories</h3>
        <ul class="list-disc pl-5 space-y-2">
            <li><strong>API Configuration</strong>: Set up your Google API key for authentication.</li>
            <li><strong>API Settings</strong>: Configure how the application interacts with the Google Analytics 4 API.</li>
            <li><strong>PDF Generation Settings</strong>: Customize PDF report generation.</li>
            <li><strong>Report Settings</strong>: Set default options for reports.</li>
            <li><strong>UI Settings</strong>: Customize the user interface.</li>
            <li><strong>Advanced Settings</strong>: Configure advanced application behavior.</li>
        </ul>
        
        <h3 class="text-md font-medium mt-4">Tips</h3>
        <ul class="list-disc pl-5 space-y-2">
            <li><strong>API Request Timeout</strong>: Increase this value if you're experiencing timeouts when fetching data for large date ranges or complex reports.</li>
            <li><strong>Max Concurrent Requests</strong>: Adjust based on your system's capabilities. Higher values may improve performance but could also lead to rate limiting.</li>
            <li><strong>Cache Timeout</strong>: Longer cache times reduce API calls but may result in slightly outdated data.</li>
            <li><strong>Log Level</strong>: Set to Debug for troubleshooting, but use Info or Warning for normal operation.</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Settings page loaded');
        
        // Toggle API key visibility
        const toggleApiKeyBtn = document.getElementById('toggle-api-key');
        const apiKeyInput = document.getElementById('setting_google_api_key');
        
        if (toggleApiKeyBtn && apiKeyInput) {
            toggleApiKeyBtn.addEventListener('click', function() {
                const type = apiKeyInput.getAttribute('type') === 'password' ? 'text' : 'password';
                apiKeyInput.setAttribute('type', type);
                
                // Update icon
                if (type === 'text') {
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" />
                            <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z" />
                        </svg>
                    `;
                } else {
                    this.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                    `;
                }
            });
        }
    });
</script>
{% endblock %}